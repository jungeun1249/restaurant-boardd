<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>글 수정</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d167bce40f724f4556f19ac97ffbd95d&libraries=services"></script>
  <style>
    #map { width: 100%; height: 350px; border-radius: 10px; margin-top: 10px; }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h3 class="mb-4">✏️ 게시글 수정</h3>

    <form action="/edit/<%= post.id %>" method="POST" enctype="multipart/form-data">
      <div class="mb-3">
        <label class="form-label">제목</label>
        <input type="text" class="form-control" name="title" value="<%= post.title %>" required>
      </div>

      <div class="mb-3">
        <label class="form-label">내용</label>
        <textarea class="form-control" name="content" rows="5" required><%= post.content %></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">평점</label>
        <input type="number" name="rating" class="form-control" value="<%= post.rating %>" min="1" max="5">
      </div>

      <div class="mb-3">
        <label class="form-label">가게 위치</label>
        <div class="input-group mb-2">
          <input type="text" id="place-input" class="form-control" placeholder="가게명 또는 주소 입력">
          <button type="button" class="btn btn-outline-primary" id="search-btn">검색</button>
        </div>
        <div id="map"></div>
        <input type="hidden" name="lat" id="lat" value="<%= post.lat %>">
        <input type="hidden" name="lng" id="lng" value="<%= post.lng %>">
      </div>

      <div class="mb-3">
        <label class="form-label">이미지</label>
        <% if (post.image) { %>
          <img src="/uploads/<%= post.image %>" width="150" class="d-block mb-2">
          <input type="hidden" name="existingImage" value="<%= post.image %>">
        <% } %>
        <input type="file" name="image" class="form-control">
      </div>

      <button type="submit" class="btn btn-primary">저장</button>
      <a href="/post/<%= post.id %>" class="btn btn-secondary">취소</a>
    </form>
  </div>

  <script>
    const lat = <%= post.lat || 37.5665 %>;
    const lng = <%= post.lng || 126.9780 %>;
    const mapContainer = document.getElementById('map');
    const mapOption = { center: new kakao.maps.LatLng(lat, lng), level: 3 };
    const map = new kakao.maps.Map(mapContainer, mapOption);
    const geocoder = new kakao.maps.services.Geocoder();
    const marker = new kakao.maps.Marker({ position: new kakao.maps.LatLng(lat, lng) });
    marker.setMap(map);

    <% if (session.user && session.user.nickname === post.nickname) { %>
      kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        const latlng = mouseEvent.latLng;
        marker.setPosition(latlng);
        document.getElementById('lat').value = latlng.getLat();
        document.getElementById('lng').value = latlng.getLng();
      });

      document.getElementById('search-btn').addEventListener('click', () => {
        const keyword = document.getElementById('place-input').value.trim();
        if (!keyword) return alert('검색어를 입력해주세요.');

        geocoder.addressSearch(keyword, function(result, status) {
          if (status === kakao.maps.services.Status.OK) {
            const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
            map.setCenter(coords);
            marker.setPosition(coords);
            document.getElementById('lat').value = result[0].y;
            document.getElementById('lng').value = result[0].x;
          } else {
            alert('위치를 찾을 수 없습니다.');
          }
        });
      });
    <% } %>
  </script>
</body>
</html>
